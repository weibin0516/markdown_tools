<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Markdown æ™ºèƒ½åˆ†é¡µåˆ‡å›¾å·¥å…·</title>
    
    <!-- Chosen Palette: Warm Neutrals -->
    <!-- Application Structure Plan: é‡‡ç”¨ç»å…¸çš„åŒæ å¸ƒå±€ã€‚å·¦ä¾§ä¸ºæ§åˆ¶é¢æ¿ï¼ŒåŒ…å«Markdownç¼–è¾‘å™¨å’Œæ‰€æœ‰æ ·å¼è‡ªå®šä¹‰é€‰é¡¹ï¼Œä½¿ç”¨æˆ·å¯ä»¥æ–¹ä¾¿åœ°è¾“å…¥å†…å®¹å¹¶è°ƒæ•´å¤–è§‚ã€‚å³ä¾§ä¸ºå®æ—¶é¢„è§ˆåŒºåŸŸï¼Œå³æ—¶åé¦ˆç”¨æˆ·çš„æ¯ä¸€æ¬¡ä¿®æ”¹ï¼Œå¿ å®æ¨¡æ‹Ÿæœ€ç»ˆçš„å›¾ç‰‡åˆ†é¡µæ•ˆæœã€‚è¿™ç§ç»“æ„å°†â€œè¾“å…¥/æ§åˆ¶â€ä¸â€œè¾“å‡º/ç»“æœâ€æ¸…æ™°åˆ†ç¦»ï¼Œç¬¦åˆåˆ›ä½œè€…å·¥å…·çš„ç›´è§‰ï¼Œå®ç°äº†â€œæ‰€è§å³æ‰€å¾—â€çš„æ ¸å¿ƒç”¨æˆ·æµç¨‹ï¼šç¼–è¾‘ -> é¢„è§ˆ -> è°ƒæ•´ -> å¯¼å‡ºã€‚ -->
    <!-- Visualization & Content Choices: PRD -> æ ¸å¿ƒç›®æ ‡æ˜¯å°†Markdownæ¸²æŸ“ä¸ºåˆ†é¡µå›¾ç‰‡ã€‚ -> å‘ˆç°æ–¹å¼æ˜¯ä½¿ç”¨HTML/CSSåœ¨DOMä¸­åˆ›å»ºæ¨¡æ‹Ÿé¡µé¢ï¼Œå¹¶ç”¨JSå®ç°æ™ºèƒ½åˆ†é¡µç®—æ³•ã€‚ -> äº¤äº’æ ¸å¿ƒæ˜¯ç¼–è¾‘å™¨çš„`input`äº‹ä»¶è§¦å‘å®æ—¶é‡æ–°æ¸²æŸ“å’Œåˆ†é¡µã€‚->  justification: è¿™æ˜¯å®ç°å®æ—¶é¢„è§ˆå’Œå¤æ‚åˆ†é¡µé€»è¾‘çš„æœ€ç›´æ¥ã€æœ€é«˜æ•ˆçš„æ–¹å¼ã€‚ -> ä½¿ç”¨çš„åº“: Tailwind CSS (å¸ƒå±€), marked.js (Markdownè§£æ), highlight.js (ä»£ç é«˜äº®), html2canvas.js (æˆªå›¾), jszip.js (æ‰“åŒ…)ã€‚ -->
    <!-- CONFIRMATION: NO SVG graphics used. NO Mermaid JS used. -->

    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/marked/11.1.1/marked.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/dom-to-image/2.6.0/dom-to-image.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/atom-one-dark.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&family=Noto+Serif+SC:wght@400;700&display=swap');
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Helvetica Neue', Arial, sans-serif;
            background-color: #F8F5F2; /* Warm Neutral Background */
        }
        .preview-page {
            width: 330px;
            min-height: 440px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            overflow: visible;
            flex-shrink: 0;
            background-color: white;
            transition: all 0.2s ease-in-out;
            position: relative; /* æ˜ç¡®è®¾ç½®å®šä½ï¼Œç¡®ä¿åŒ…å«ç»å¯¹å®šä½çš„å­å…ƒç´  */
        }
        .preview-page-content {
            box-sizing: border-box;
            overflow: visible;
            word-wrap: break-word;
            hyphens: auto;
        }
        .rendered-content h1 {
            font-size: 1.3em;
            font-weight: bold;
            margin: 0.4em 0 0.3em 0;
            line-height: 1.3;
            border-bottom: 2px solid currentColor;
            padding-bottom: 0.2em;
        }
        .rendered-content h2 {
            font-size: 1.1em;
            font-weight: bolder;
            margin: 0.6em 0.4em 0.2em 0;
            padding-left: 0.4em;
            border-left: 5px solid currentColor;
            line-height: 1.3;
        }
        .rendered-content h3 {
            font-size: 0.875em;
            margin: 0.3em 0 0.2em 0;
            line-height: 1.3;
            font-weight: bold;
        }
        .rendered-content h1:first-child, .rendered-content h2:first-child, .rendered-content h3:first-child {
            margin-top: 0;
        }
        .rendered-content h4, .rendered-content h5, .rendered-content h6 {
            font-size: 0.875em;
            line-height: 1.3;
            margin: 0.4em 0 0.2em 0;
            font-weight: bold;
        }
        .rendered-content p {
            margin: 0.3em 0.4em;
            line-height: 1.6;
            letter-spacing: 0.1em;
            font-size: 0.875em;
            word-spacing: 0.05em;
        }
        .rendered-content p:empty {
            display: none;
        }
        .rendered-content ul, .rendered-content ol {
            font-size: 0.875em;
            margin-left: 1.2em;
            margin-bottom: 0.8em;
            padding-left: 0.8em;
        }
        .rendered-content ul {
            list-style-type: disc;
        }
        .rendered-content ol {
            list-style-type: decimal;
        }
        .rendered-content ul ul {
            list-style-type: circle;
        }
        .rendered-content ul ul ul {
            list-style-type: square;
        }
        .rendered-content li {
            font-size: 1em;
            margin-bottom: 0.3em;
            line-height: 1.6;
            display: list-item;
            vertical-align: baseline;
        }
        .rendered-content li::marker {
            vertical-align: baseline;
        }
        .rendered-content blockquote {
            font-style: normal;
            border-left: none;
            padding: 0.6em;
            position: relative;
            line-height: 1.8;
            border-radius: 0 0 0.6em 0.6em;
            margin: 0.5em 0;
            /* color, background, box-shadow will be set by theme */
        }
        .rendered-content blockquote p {
            font-size: 0.8em !important;
            margin: 0 !important;
            letter-spacing: normal !important;
            /* color will be set by theme */
        }
        .rendered-content img {
            max-width: 100%;
            border-radius: 8px;
            margin-bottom: 0.8em;
        }
        .rendered-content pre {
            margin: 0.5em 0;
            padding: 0.5em;
            border-radius: 4px;
            line-height: 1.4;
            overflow-x: auto;
        }
        .rendered-content code {
            color: rgb(271,93,108);
            background-color: #f3f4f6;
            padding: 0.2em 0.4em;
            border-radius: 3px;
            font-family: 'Courier New', Courier, monospace;
            font-size: 0.9em;
        }
        .rendered-content pre code {
            background-color: transparent;
            padding: 0;
            color: inherit;
        }
        .rendered-content strong {
            font-weight: bold;
            vertical-align: baseline;
            line-height: inherit;
            /* color will be set by theme */
        }
        .rendered-content em {
            letter-spacing: 0.3em;
            vertical-align: baseline;
            line-height: inherit;
            /* color will be set by theme */
        }
        .rendered-content a {
            text-decoration: none;
            vertical-align: baseline;
            line-height: inherit;
            /* color and border-bottom will be set by theme */
        }
        .rendered-content table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 0.8em;
            border: 1px solid #ddd;
            background-color: #fff;
        }
        .rendered-content th, .rendered-content td {
            font-size: 0.875em;
            border: 1px solid #ddd;
            padding: 0.5em 0.8em;
            text-align: left;
            vertical-align: top;
            word-wrap: break-word;
            max-width: 200px;
        }
        .rendered-content th {
            font-weight: bold;
            background-color: #f8f9fa;
            color: #333;
        }
        .rendered-content tbody tr:nth-child(even) {
            background-color: #f8f9fa;
        }
        .rendered-content tbody tr:hover {
            background-color: #e9ecef;
        }
        .rendered-content hr {
            height: 1px;
            padding: 0;
            border: none;
            text-align: center;
            background-image: linear-gradient(to right, rgba(248,57,41,0), rgba(248,57,41,0.75), rgba(248,57,41,0));
            margin: 0.8em 0;
        }

        /* For the pagination algorithm */
        #hidden-renderer {
            position: absolute;
            top: -9999px;
            left: -9999px;
            visibility: hidden;
            width: 330px; /* Same as preview page */
        }
    </style>
</head>
<body class="text-gray-800">
    <div class="flex flex-col h-screen">
        <!-- Header -->
        <header class="bg-white/80 backdrop-blur-sm border-b border-gray-200/80 p-4 flex justify-between items-center z-20">
            <div class="flex items-center gap-3">
                <div class="w-8 h-8 bg-orange-500 rounded-lg flex items-center justify-center text-white font-bold text-xl">
                    <span>M</span>
                </div>
                <h1 class="text-xl font-bold text-gray-800">Markdown æ™ºèƒ½åˆ†é¡µåˆ‡å›¾å·¥å…·</h1>
            </div>
            <div class="flex items-center gap-4">
                <button id="export-zip-btn" class="bg-orange-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-orange-600 transition-colors flex items-center gap-2">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm3.293-7.707a1 1 0 011.414 0L9 10.586V3a1 1 0 112 0v7.586l1.293-1.293a1 1 0 111.414 1.414l-3 3a1 1 0 01-1.414 0l-3-3a1 1 0 010-1.414z" clip-rule="evenodd" /></svg>
                    å¯¼å‡ºå›¾ç‰‡ (ZIP)
                </button>
                 <div id="loading-indicator" class="hidden items-center gap-2">
                    <div class="animate-spin rounded-full h-5 w-5 border-b-2 border-orange-500"></div>
                    <span>å¤„ç†ä¸­...</span>
                </div>
            </div>
        </header>

        <div class="flex flex-grow overflow-hidden">
            <!-- Left: Controls -->
            <aside class="w-1/3 min-w-[400px] max-w-[600px] bg-white border-r border-gray-200/80 flex flex-col p-6 overflow-y-auto">
                <!-- Editor Section -->
                <div class="flex flex-col" style="height: 320px;">
                    <h2 class="text-lg font-bold mb-3">1. ç¼–å†™å†…å®¹</h2>
                    <p class="text-sm text-gray-500 mb-4">åœ¨æ­¤å¤„è¾“å…¥æˆ–ç²˜è´´æ‚¨çš„ Markdown å†…å®¹ã€‚å³ä¾§å°†å®æ—¶å±•ç¤ºåˆ†é¡µåçš„é¢„è§ˆæ•ˆæœã€‚</p>
                    <textarea id="markdown-input" class="w-full flex-grow border border-gray-300 rounded-lg p-4 text-sm leading-6 resize-none focus:ring-2 focus:ring-orange-400 focus:border-transparent transition" spellcheck="false"></textarea>
                </div>
                <!-- Customization Section -->
                <div class="mt-8 flex-grow">
                    <h2 class="text-lg font-bold mb-4">2. è‡ªå®šä¹‰æ ·å¼</h2>
                    
                    <!-- ç¬¬ä¸€è¡Œï¼šä¸»é¢˜å’Œå­—ä½“ -->
                    <div class="grid grid-cols-2 gap-4 mb-4">
                        <div>
                            <label for="theme-select" class="block text-sm font-medium text-gray-700 mb-2">ä¸»é¢˜é£æ ¼</label>
                            <select id="theme-select" class="w-full border-gray-300 rounded-lg shadow-sm focus:ring-orange-500 focus:border-orange-500 text-sm py-2">
                                <option value="sunshine">å°å¤ªé˜³ï¼ˆé»˜è®¤ï¼‰</option>
                                <option value="liuliu">å…­å…­</option>
                                <option value="liuliu2">å…­å…­2</option>
                                <option value="zoro">ç´¢éš†</option>
                            </select>
                        </div>

                        <div>
                            <label for="font-select" class="block text-sm font-medium text-gray-700 mb-2">å†…å®¹å­—ä½“</label>
                            <select id="font-select" class="w-full border-gray-300 rounded-lg shadow-sm focus:ring-orange-500 focus:border-orange-500 text-sm py-2">
                                <option value="-apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Helvetica Neue', Arial, sans-serif">ç³»ç»Ÿé»˜è®¤å­—ä½“</option>
                                <option value="'Inter', 'Noto Serif SC', sans-serif">ç°ä»£æ— è¡¬çº¿</option>
                                <option value="'Noto Serif SC', serif">å…¸é›…è¡¬çº¿ä½“</option>
                            </select>
                        </div>
                    </div>

                    <!-- ç¬¬äºŒè¡Œï¼šæ»‘å—æ§ä»¶ -->
                    <div class="grid grid-cols-2 gap-4 mb-4">
                        <div>
                            <label for="font-size-slider" class="block text-sm font-medium text-gray-700 mb-2">
                                å­—ä½“å¤§å°: <span id="font-size-value" class="text-orange-600 font-semibold">13</span>px
                            </label>
                            <input id="font-size-slider" type="range" min="12" max="24" value="13" class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer accent-orange-500">
                        </div>
                        <div>
                            <label for="padding-slider" class="block text-sm font-medium text-gray-700 mb-2">
                                é¡µé¢è¾¹è·: <span id="padding-value" class="text-orange-600 font-semibold">15</span>px
                            </label>
                            <input id="padding-slider" type="range" min="10" max="60" value="15" class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer accent-orange-500">
                        </div>
                    </div>

                    <!-- ç¬¬ä¸‰è¡Œï¼šæ°´å°é€‰é¡¹ -->
                    <div class="pt-3 border-t border-gray-200">
                        <div class="flex items-center">
                            <input id="watermark-checkbox" type="checkbox" checked class="h-4 w-4 text-orange-600 focus:ring-orange-500 border-gray-300 rounded cursor-pointer">
                            <label for="watermark-checkbox" class="ml-2 block text-sm font-medium text-gray-700 cursor-pointer">æ˜¾ç¤ºæ°´å°</label>
                        </div>
                    </div>
                </div>
            </aside>
            
            <!-- Right: Preview -->
            <main class="w-2/3 flex-grow bg-gray-100 p-8 overflow-y-auto">
                <div id="preview-area" class="flex flex-wrap gap-8 justify-center">
                    <!-- Preview pages will be generated here -->
                </div>
            </main>
        </div>
    </div>
    
    <!-- This is hidden. It's used to render the full content to calculate pagination -->
    <div id="hidden-renderer"></div>

    <script>
        document.addEventListener('DOMContentLoaded', function () {
            // Wait for all scripts to load
            const checkLibraries = () => {
                return window.marked && window.hljs && window.html2canvas && window.domtoimage && window.JSZip;
            };

            const initApp = () => {
                // Configure marked.js with highlight.js for syntax highlighting
                marked.use({
                    renderer: {
                        code(code, infostring) {
                            const lang = infostring || 'plaintext';
                            const language = hljs.getLanguage(lang) ? lang : 'plaintext';
                            const highlighted = hljs.highlight(code, { language, ignoreIllegals: true }).value;
                            return `<pre><code class="hljs ${language}">${highlighted}</code></pre>`;
                        }
                    },
                    gfm: true,
                    breaks: true
                });

                // Elements
                const markdownInput = document.getElementById('markdown-input');
                const previewArea = document.getElementById('preview-area');
                const hiddenRenderer = document.getElementById('hidden-renderer');

                const themeSelect = document.getElementById('theme-select');
                const fontSelect = document.getElementById('font-select');
                const paddingSlider = document.getElementById('padding-slider');
                const paddingValue = document.getElementById('padding-value');
                const fontSizeSlider = document.getElementById('font-size-slider');
                const fontSizeValue = document.getElementById('font-size-value');
                const watermarkCheckbox = document.getElementById('watermark-checkbox');
                const exportBtn = document.getElementById('export-zip-btn');
                const loadingIndicator = document.getElementById('loading-indicator');

                // Default content
                const defaultMarkdown = `# æ¬¢è¿ä½¿ç”¨ Markdown é•¿å›¾åˆ†é¡µå·¥å…·

## åŠŸèƒ½ç‰¹ç‚¹

è¿™æ˜¯ä¸€ä¸ªæ™ºèƒ½çš„ Markdown æ¸²æŸ“å·¥å…·ï¼Œå¯ä»¥å°†ä½ çš„æ–‡æ¡£è½¬æ¢ä¸ºç¾è§‚çš„å›¾ç‰‡åºåˆ—ã€‚

### æ”¯æŒçš„åŠŸèƒ½

- **å®æ—¶é¢„è§ˆ**ï¼šå·¦ä¾§ç¼–è¾‘ï¼Œå³ä¾§å®æ—¶æ˜¾ç¤ºåˆ†é¡µæ•ˆæœ
- **æ™ºèƒ½åˆ†é¡µ**ï¼šè‡ªåŠ¨è¯†åˆ«å†…å®¹å—ï¼Œé¿å…ä¸åˆç†çš„æˆªæ–­
- **å¤å¤ä¸»é¢˜**ï¼šé‡‡ç”¨å¤å¤ç‰›çš®çº¸é£æ ¼ï¼Œæ¸©é¦¨å…¸é›…
- **ä»£ç é«˜äº®**ï¼šæ”¯æŒå¤šç§ç¼–ç¨‹è¯­è¨€çš„è¯­æ³•é«˜äº®

### ç¤ºä¾‹ä»£ç 

\`\`\`javascript
function generatePages(markdown) {
  const html = parseMarkdown(markdown);
  const pages = paginateContent(html);
  return pages;
}
\`\`\`

### ä½¿ç”¨åœºæ™¯

1. **çŸ¥è¯†åˆ†äº«**ï¼šå°†æŠ€æœ¯æ–‡æ¡£è½¬æ¢ä¸ºå›¾ç‰‡ï¼Œæ–¹ä¾¿åœ¨ç¤¾äº¤åª’ä½“åˆ†äº«
2. **ç¬”è®°æ•´ç†**ï¼šå°†å­¦ä¹ ç¬”è®°åˆ¶ä½œæˆå›¾ç‰‡æ ¼å¼ï¼Œä¾¿äºç§»åŠ¨ç«¯æŸ¥çœ‹
3. **æ•™ç¨‹åˆ¶ä½œ**ï¼šåˆ›å»ºstep-by-stepçš„æ•™ç¨‹å›¾ç‰‡

### å®½è¡¨æ ¼ç¤ºä¾‹

ä¸‹é¢æ˜¯ä¸€ä¸ªå®½è¡¨æ ¼ï¼Œç³»ç»Ÿä¼šè‡ªåŠ¨å°†å…¶è½¬æ¢ä¸ºå›¾ç‰‡ä»¥ä¾¿æ›´å¥½åœ°æ˜¾ç¤ºï¼š

| æŒ‡æ ‡/å­£åº¦ | 2023Q2 | 2023Q3 | 2023Q4 | 2024Q1 | 2024Q2 | 2024Q3 | 2024Q4 | 2025Q1 | è¯„çº§ |
|----------|--------|--------|--------|--------|--------|--------|--------|--------|---------|
| è¥ä¸šæ”¶å…¥(äº¿å…ƒ) | 749.45 | 750.63 | 1183.95 | 747.77 | 756.40 | 799.79 | 1532.23 | 789.28 | ä¼˜ç§€ |
| å‡€åˆ©æ¶¦(äº¿å…ƒ) | 39.46 | 61.19 | 133.94 | 76.49 | 108.27 | 112.02 | 197.15 | 124.65 | æä½³ |
| èµ„äº§æ€»è®¡(äº¿å…ƒ) | 3265.50 | 3308.05 | 3430.06 | 3559.07 | 3688.76 | 3780.56 | 3966.11 | 4116.47 | ä¸­ç­‰ |
| è´Ÿå€ºåˆè®¡(äº¿å…ƒ) | 1924.69 | 1952.57 | 2046.43 | 2074.76 | 2089.84 | 2093.79 | 2188.80 | 2259.51 | ä¸­ç­‰ |
| å›ºå®šèµ„äº§(äº¿å…ƒ) | 794.31 | 806.41 | 814.66 | 813.63 | 835.87 | 850.76 | 923.07 | 927.22 | ä¸­ç­‰ |

> ğŸ’¡ **æç¤º**ï¼šåœ¨å·¦ä¾§ç¼–è¾‘å™¨ä¸­è¾“å…¥ä½ çš„ Markdown å†…å®¹ï¼Œå³ä¾§ä¼šå®æ—¶æ˜¾ç¤ºåˆ†é¡µæ•ˆæœã€‚

---

**å¼€å§‹ç¼–è¾‘å§ï¼** ğŸš€`;

                markdownInput.value = defaultMarkdown;

                // Define themes first - ä¸º30+ä¸­å¹´ç”·æ€§ç”¨æˆ·è®¾è®¡çš„é…è‰²æ–¹æ¡ˆ
                const themes = {
                    sunshine: {
                        name: 'å°å¤ªé˜³',
                        background: '#ffffff',
                        text: '#3f2a1d',
                        accent: '#ffb74d',
                        border: '#ffe0b2',
                        codeBackground: '#fff3e0',
                        headingColor: '#f57c00',
                        strongColor: '#ef6c00',
                        linkColor: '#fb8c00',
                        blockquoteStyle: {
                            background: 'linear-gradient(135deg, #ffd54f 0%, #ffb300 100%)',
                            color: '#3f2a1d',
                            boxShadow: 'rgba(255, 171, 64, 0.45) 0 0.5em 0.8em'
                        }
                    },
                    liuliu: {
                        name: 'å…­å…­',
                        background: '#eceff1',
                        text: '#263238',
                        accent: '#546e7a',
                        border: '#b0bec5',
                        codeBackground: '#cfd8dc',
                        headingColor: '#37474f',
                        strongColor: '#1565c0',  // å•†åŠ¡è“ï¼Œä¸“ä¸šå¯é 
                        linkColor: '#0d47a1',    // æ·±è“è‰²
                        blockquoteStyle: {
                            background: 'linear-gradient(135deg, #455a64 0%, #546e7a 100%)',
                            color: '#eceff1',
                            boxShadow: '#78909c 0 0.5em 0.8em'
                        }
                    },
                    liuliu2: {
                        name: 'å…­å…­2',
                        background: '#f5f5f0',  // æ¸©æš–çš„ç±³ç™½è‰²èƒŒæ™¯
                        text: '#3e3e3e',        // æ·±ç°è‰²æ–‡å­—
                        accent: '#8b7355',      // æ²‰ç¨³çš„è¤è‰²å¼ºè°ƒ
                        border: '#d4c5b9',      // æŸ”å’Œçš„è¤è‰²è¾¹æ¡†
                        codeBackground: '#ebe8e1',  // æµ…ç±³è‰²ä»£ç èƒŒæ™¯
                        headingColor: '#5a4a3a',    // æ·±è¤è‰²æ ‡é¢˜
                        strongColor: '#c1440e',     // æš–æ©™çº¢è‰²åŠ ç²—ï¼Œä¸è¤è‰²ä¸»é¢˜å½¢æˆå¯¹æ¯”
                        linkColor: '#a23a0a',       // æ·±æ©™è‰²é“¾æ¥
                        blockquoteStyle: {
                            background: 'linear-gradient(135deg, #6b5d4f 0%, #8b7355 100%)',
                            color: '#f5f5f0',
                            boxShadow: '#9d8b73 0 0.5em 0.8em'
                        }
                    },
                    zoro: {
                        name: 'ç´¢éš†',
                        background: '#263238',
                        text: '#cfd8dc',
                        accent: '#78909c',
                        border: '#455a64',
                        codeBackground: '#37474f',
                        headingColor: '#90a4ae',
                        strongColor: '#ffa726',  // æ¸©æš–æ©™è‰²ï¼ŒæŠ¤çœ¼é†’ç›®
                        linkColor: '#ff9800',    // æ©™è‰²
                        blockquoteStyle: {
                            background: 'linear-gradient(135deg, #1c313a 0%, #263238 100%)',
                            color: '#b0bec5',
                            boxShadow: '#455a64 0 0.4em 0.6em'
                        }
                    }
                };



                // App State
                const state = {
                    markdown: markdownInput.value,
                    theme: 'sunshine',
                    fontFamily: "-apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Helvetica Neue', Arial, sans-serif",
                    padding: 15,
                    fontSize: 13,
                    showWatermark: true,
                };


                
                // --- RENDER & PAGINATION LOGIC ---
                
                async function renderAndPaginate() {
                    try {
                        // 1. å¤„ç†\nç¬¦å·ï¼Œå°†å…¶è½¬æ¢ä¸ºå®é™…æ¢è¡Œ
                        const processedMarkdown = state.markdown.replace(/\\n/g, '\n');
                        
                        // 2. Parse Markdown to HTML
                        const rawHtml = marked.parse(processedMarkdown);
                        
                        // 2. Style the hidden renderer for measurement
                        hiddenRenderer.className = `rendered-content`;
                        hiddenRenderer.style.padding = `${state.padding}px`;
                        hiddenRenderer.style.fontSize = `${state.fontSize}px`;
                        hiddenRenderer.style.fontFamily = state.fontFamily;
                        hiddenRenderer.innerHTML = rawHtml;
                        
                        // Clear previous preview
                        previewArea.innerHTML = '';
                        
                        const pageHeight = 440; // Fixed page height
                        const contentHeight = pageHeight - (state.padding * 2);

                        let currentPageDiv;
                        let pageContentDiv;

                        function createNewPage() {
                            currentPageDiv = document.createElement('div');
                            currentPageDiv.className = 'preview-page';
                            currentPageDiv.style.position = 'relative';
                            
                            pageContentDiv = document.createElement('div');
                            pageContentDiv.className = 'rendered-content preview-page-content';
                            pageContentDiv.style.padding = `${state.padding}px`;
                            pageContentDiv.style.fontSize = `${state.fontSize}px`;
                            pageContentDiv.style.fontFamily = state.fontFamily;
                            pageContentDiv.style.minHeight = `${contentHeight}px`;
                            pageContentDiv.style.height = 'auto';
                            pageContentDiv.style.overflow = 'visible';
                            pageContentDiv.style.wordWrap = 'break-word';
                            pageContentDiv.style.hyphens = 'auto';

                            // åˆ›å»ºæ°´å°å…ƒç´ ï¼ˆå¦‚æœå¯ç”¨ï¼‰
                            if (state.showWatermark) {
                                const watermark = document.createElement('div');
                                watermark.textContent = 'ä½¿ç”¨ã€Œå£è¢‹åˆ†æå¸ˆã€å¾®ä¿¡å°ç¨‹åºç”Ÿæˆ  å¯ç”Ÿæˆä»»æ„å…¬å¸åŒæ¬¾æŠ¥å‘Š';
                                watermark.style.position = 'absolute';
                                watermark.style.bottom = '8px';
                                watermark.style.right = '12px';
                                watermark.style.fontSize = '11px';
                                watermark.style.color = '#28A745';
                                watermark.style.opacity = '0.9';
                                watermark.style.fontFamily = '-apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif';
                                watermark.style.fontWeight = 'bold';
                                watermark.style.pointerEvents = 'none';
                                watermark.style.userSelect = 'none';
                                watermark.style.zIndex = '1000';
                                currentPageDiv.appendChild(watermark);
                            }

                            applyTheme(currentPageDiv, pageContentDiv);
                            
                            currentPageDiv.appendChild(pageContentDiv);
                            previewArea.appendChild(currentPageDiv);
                            
                            console.log(`Created new page. Content height: ${contentHeight}px, Page height: ${pageHeight}px, Padding: ${state.padding}px`);
                        }

                        // æ™ºèƒ½åˆ†é¡µç®—æ³• - ä¿æŒå†…å®¹è¿è´¯æ€§
                        createNewPage();
                        const elements = Array.from(hiddenRenderer.children);
                        
                        console.log('Total elements:', elements.length);
                        elements.forEach((el, i) => {
                            const text = el.textContent?.trim() || '';
                            console.log(`Element ${i}:`, el.tagName, text.length > 50 ? text.substring(0, 50) + '...' : text);
                        });

                        const isHeader = (element) => {
                            return element.tagName && ['H1', 'H2', 'H3', 'H4', 'H5', 'H6'].includes(element.tagName);
                        };

                        // å¤„ç†å®½è¡¨æ ¼è½¬æ¢ä¸ºå›¾ç‰‡çš„å‡½æ•°
                        async function convertWideTableToImage(tableElement) {
                            try {
                                // åˆ›å»ºä¸€ä¸ªä¸´æ—¶å®¹å™¨æ¥æ¸²æŸ“è¡¨æ ¼
                                const tempContainer = document.createElement('div');
                                tempContainer.style.position = 'absolute';
                                tempContainer.style.top = '-9999px';
                                tempContainer.style.left = '-9999px';
                                tempContainer.style.backgroundColor = 'white';
                                tempContainer.style.padding = '12px';
                                tempContainer.style.fontFamily = state.fontFamily;
                                tempContainer.style.fontSize = state.fontSize + 'px';
                                
                                // å…‹éš†è¡¨æ ¼å¹¶è®¾ç½®æ ·å¼
                                const clonedTable = tableElement.cloneNode(true);
                                clonedTable.style.width = 'auto';
                                clonedTable.style.minWidth = 'max-content';
                                clonedTable.style.borderCollapse = 'collapse';
                                clonedTable.style.border = '1px solid #ccc';
                                clonedTable.style.backgroundColor = '#fff';
                                
                                // è®¾ç½®å•å…ƒæ ¼æ ·å¼ - å±…ä¸­æ˜¾ç¤ºï¼Œå­—ä½“æ”¾å¤§
                                clonedTable.querySelectorAll('th, td').forEach(cell => {
                                    cell.style.border = '1px solid #ddd';
                                    cell.style.padding = '8px 12px';  // å¢åŠ å†…è¾¹è·
                                    cell.style.textAlign = 'center';  // æ–‡å­—å±…ä¸­
                                    cell.style.verticalAlign = 'middle';  // å‚ç›´å±…ä¸­
                                    cell.style.whiteSpace = 'nowrap';
                                    cell.style.maxWidth = 'none';
                                    cell.style.fontSize = state.fontSize * 1.1 + 'px';  // å­—ä½“æ”¾å¤§10%
                                });
                                
                                clonedTable.querySelectorAll('th').forEach(th => {
                                    th.style.fontWeight = 'bold';
                                    th.style.backgroundColor = '#f5f5f5';
                                    th.style.color = '#333';
                                });
                                
                                tempContainer.appendChild(clonedTable);
                                document.body.appendChild(tempContainer);
                                
                                // ä½¿ç”¨html2canvasè½¬æ¢ä¸ºå›¾ç‰‡
                                const canvas = await html2canvas(tempContainer, {
                                    backgroundColor: 'white',
                                    scale: 2.5,  // æé«˜æ¸…æ™°åº¦
                                    useCORS: true,
                                    allowTaint: true
                                });
                                
                                // æ¸…ç†ä¸´æ—¶å®¹å™¨
                                document.body.removeChild(tempContainer);
                                
                                // åˆ›å»ºå›¾ç‰‡å…ƒç´ 
                                const img = document.createElement('img');
                                img.src = canvas.toDataURL('image/png');
                                img.style.maxWidth = '100%';
                                img.style.height = 'auto';
                                img.style.border = 'none';
                                img.style.borderRadius = '4px';
                                img.style.display = 'block';
                                img.style.margin = '12px auto';
                                
                                return img;
                            } catch (error) {
                                console.error('è½¬æ¢è¡¨æ ¼ä¸ºå›¾ç‰‡å¤±è´¥:', error);
                                return tableElement.cloneNode(true);
                            }
                        }

                        // æŒ‰è¡Œåˆ†é¡µå¤„ç†æ–‡æœ¬å…ƒç´ çš„å‡½æ•°
                        async function processTextElementByLines(element, elementIndex) {
                            const textContent = element.textContent?.trim() || '';
                            if (!textContent) return;
                            
                            console.log(`Processing text element by lines: ${element.tagName}`);
                            
                            // åˆ›å»ºä¸€ä¸ªä¸´æ—¶å…ƒç´ æ¥æµ‹é‡è¡Œé«˜
                            const tempElement = element.cloneNode(true);
                            tempElement.style.position = 'absolute';
                            tempElement.style.visibility = 'hidden';
                            tempElement.style.width = `${pageContentDiv.offsetWidth}px`;
                            tempElement.style.height = 'auto';
                            tempElement.style.whiteSpace = 'normal';
                            tempElement.style.wordWrap = 'break-word';
                            document.body.appendChild(tempElement);
                            
                            // è·å–å•è¡Œé«˜åº¦
                            const originalHTML = tempElement.innerHTML;
                            tempElement.textContent = 'A';
                            const lineHeight = tempElement.offsetHeight;
                            tempElement.innerHTML = originalHTML;
                            const totalHeight = tempElement.offsetHeight;
                            const totalLines = Math.ceil(totalHeight / lineHeight);
                            
                            console.log(`Element has ${totalLines} lines, line height: ${lineHeight}px`);
                            
                            // å¦‚æœåªæœ‰ä¸€è¡Œæˆ–è€…æ˜¯ç‰¹æ®Šå…ƒç´ ï¼Œç›´æ¥æŒ‰æ•´ä¸ªå…ƒç´ å¤„ç†
                            if (totalLines <= 1 || element.tagName === 'H1' || element.tagName === 'H2' || 
                                element.tagName === 'H3' || element.tagName === 'H4' || element.tagName === 'H5' || element.tagName === 'H6') {
                                document.body.removeChild(tempElement);
                                return await processElementAsWhole(element, elementIndex);
                            }
                            
                            // å¯¹äºåŒ…å«HTMLæ ‡è®°çš„å…ƒç´ ï¼Œä½¿ç”¨æ›´æ™ºèƒ½çš„åˆ†å‰²æ–¹æ³•
                            // æ£€æŸ¥æ˜¯å¦åŒ…å«HTMLæ ‡è®°
                            const hasHTMLTags = element.innerHTML !== element.textContent;
                            
                            if (hasHTMLTags) {
                                // å¦‚æœåŒ…å«HTMLæ ‡è®°ï¼ŒæŒ‰æ•´ä¸ªå…ƒç´ å¤„ç†ä»¥ä¿æŒæ ¼å¼
                                document.body.removeChild(tempElement);
                                return await processElementAsWhole(element, elementIndex);
                            }
                            
                            // åˆ†å‰²æ–‡æœ¬ä¸ºå•è¯
                            const words = textContent.split(/\s+/);
                            let currentText = '';
                            let currentElement = null;
                            
                            for (let i = 0; i < words.length; i++) {
                                const testText = currentText ? currentText + ' ' + words[i] : words[i];
                                tempElement.textContent = testText;
                                
                                const testHeight = tempElement.offsetHeight;
                                
                                // ä¸´æ—¶æ·»åŠ åˆ°é¡µé¢æµ‹è¯•å®é™…é«˜åº¦
                                const testElement = element.cloneNode(false);
                                testElement.textContent = testText;
                                pageContentDiv.appendChild(testElement);
                                const wouldExceedHeight = pageContentDiv.scrollHeight > contentHeight + 20;
                                pageContentDiv.removeChild(testElement);
                                
                                // å¦‚æœæ·»åŠ è¿™ä¸ªå•è¯ä¼šè¶…å‡ºå½“å‰é¡µé¢é«˜åº¦
                                if (wouldExceedHeight && currentText) {
                                    // åˆ›å»ºå½“å‰è¡Œçš„å…ƒç´ å¹¶æ·»åŠ åˆ°é¡µé¢
                                    if (!currentElement) {
                                        currentElement = element.cloneNode(false);
                                    }
                                    currentElement.textContent = currentText;
                                    
                                    // å¦‚æœå½“å‰é¡µé¢ä¸ºç©ºï¼Œç›´æ¥æ·»åŠ 
                                    if (pageContentDiv.children.length === 0) {
                                        pageContentDiv.appendChild(currentElement);
                                    } else {
                                        // æµ‹è¯•æ˜¯å¦èƒ½æ”¾å…¥å½“å‰é¡µé¢
                                        pageContentDiv.appendChild(currentElement);
                                        if (pageContentDiv.scrollHeight > contentHeight + 20) {
                                            pageContentDiv.removeChild(currentElement);
                                            createNewPage();
                                            pageContentDiv.appendChild(currentElement);
                                        }
                                    }
                                    
                                    // é‡ç½®å½“å‰æ–‡æœ¬å’Œå…ƒç´ 
                                    currentText = words[i];
                                    currentElement = null;
                                } else {
                                    currentText = testText;
                                }
                            }
                            
                            // å¤„ç†å‰©ä½™çš„æ–‡æœ¬
                            if (currentText) {
                                if (!currentElement) {
                                    currentElement = element.cloneNode(false);
                                }
                                currentElement.textContent = currentText;
                                
                                if (pageContentDiv.children.length === 0) {
                                    pageContentDiv.appendChild(currentElement);
                                } else {
                                    pageContentDiv.appendChild(currentElement);
                                    if (pageContentDiv.scrollHeight > contentHeight + 20) {
                                        pageContentDiv.removeChild(currentElement);
                                        createNewPage();
                                        pageContentDiv.appendChild(currentElement);
                                    }
                                }
                            }
                            
                            document.body.removeChild(tempElement);
                        }
                        
                        // æŒ‰æ•´ä¸ªå…ƒç´ å¤„ç†çš„å‡½æ•°ï¼ˆç”¨äºè¡¨æ ¼ã€å›¾ç‰‡ã€é“¾æ¥ç­‰ä¸å¯åˆ†å‰²çš„å…ƒç´ ï¼‰
                        async function processElementAsWhole(element, elementIndex) {
                            // æ›´å®½æ¾çš„ç©ºç™½å…ƒç´ è¿‡æ»¤ - åªè¿‡æ»¤çœŸæ­£çš„ç©ºå…ƒç´ 
                            const textContent = element.textContent?.trim() || '';
                            const hasContent = textContent.length > 0 || 
                                             element.tagName === 'HR' || 
                                             element.tagName === 'IMG' ||
                                             element.tagName === 'BR' ||
                                             element.querySelector('img, hr, br');
                            
                            if (!hasContent) {
                                console.log(`Skipping empty element ${elementIndex}:`, element.tagName);
                                return;
                            }

                            const displayText = textContent.length > 30 ? textContent.substring(0, 30) + '...' : textContent;
                            console.log(`Adding element ${elementIndex}:`, element.tagName, displayText);
                            
                            let clonedElement;
                            
                            // æ£€æŸ¥æ˜¯å¦ä¸ºè¡¨æ ¼æˆ–åŒ…å«è¡¨æ ¼çš„å…ƒç´ 
                            let tableElement = null;
                            if (element.tagName === 'TABLE') {
                                tableElement = element;
                            } else {
                                // æ£€æŸ¥å…ƒç´ å†…éƒ¨æ˜¯å¦åŒ…å«è¡¨æ ¼
                                tableElement = element.querySelector('table');
                            }
                            
                            if (tableElement) {
                                // è®¡ç®—è¡¨æ ¼çš„åˆ—æ•°
                                const firstRow = tableElement.querySelector('tr');
                                const columnCount = firstRow ? firstRow.children.length : 0;
                                
                                // å¦‚æœåˆ—æ•°è¶…è¿‡4åˆ—ï¼Œè½¬æ¢ä¸ºå›¾ç‰‡
                                if (columnCount > 4) {
                                    console.log(`Converting wide table with ${columnCount} columns to image`);
                                    const imgElement = await convertWideTableToImage(tableElement);
                                    
                                    // å¦‚æœåŸå…ƒç´ ä¸æ˜¯è¡¨æ ¼æœ¬èº«ï¼Œéœ€è¦æ›¿æ¢è¡¨æ ¼éƒ¨åˆ†
                                    if (element.tagName !== 'TABLE') {
                                        clonedElement = element.cloneNode(true);
                                        const clonedTable = clonedElement.querySelector('table');
                                        if (clonedTable) {
                                            clonedTable.replaceWith(imgElement);
                                        }
                                    } else {
                                        clonedElement = imgElement;
                                    }
                                } else {
                                    clonedElement = element.cloneNode(true);
                                }
                            } else {
                                clonedElement = element.cloneNode(true);
                            }
                            
                            // å¦‚æœå½“å‰é¡µé¢ä¸ºç©ºï¼Œç›´æ¥æ·»åŠ ç¬¬ä¸€ä¸ªå…ƒç´ ï¼ˆé¿å…ç¬¬ä¸€é¡µç©ºç™½ï¼‰
                            if (pageContentDiv.children.length === 0) {
                                pageContentDiv.appendChild(clonedElement);
                                console.log(`First element added to page.`);
                                return;
                            }
                            
                            // ä¸´æ—¶æ·»åŠ åˆ°å½“å‰é¡µé¢ä»¥æµ‹è¯•é«˜åº¦
                            pageContentDiv.appendChild(clonedElement);
                            pageContentDiv.offsetHeight;
                            const currentHeight = pageContentDiv.scrollHeight;
                            
                            console.log(`Page height after adding: ${currentHeight}/${contentHeight}`);

                            // æ£€æŸ¥æ˜¯å¦è¶…å‡ºé¡µé¢é«˜åº¦ï¼ˆä½¿ç”¨æ›´å®½æ¾çš„å®¹é”™å€¼ï¼‰
                            if (currentHeight > contentHeight + 20) {
                                console.log(`Page overflow! Current: ${currentHeight}px, Limit: ${contentHeight + 20}px`);
                                // ç§»é™¤åˆšæ·»åŠ çš„å…ƒç´ ï¼ˆå› ä¸ºæ”¾ä¸ä¸‹ï¼‰
                                pageContentDiv.removeChild(clonedElement);
                                
                                // åˆ›å»ºæ–°é¡µé¢
                                console.log(`Creating new page. Previous page has ${pageContentDiv.children.length} elements.`);
                                createNewPage();
                                
                                // å°†å…ƒç´ æ·»åŠ åˆ°æ–°é¡µé¢
                                pageContentDiv.appendChild(clonedElement);
                                console.log(`Element added to new page.`);
                            } else {
                                console.log(`Element fits on current page. Height: ${currentHeight}/${contentHeight + 20}`);
                            }
                        }
                        
                        // å¤„ç†å…ƒç´ çš„ä¸»å‡½æ•°ï¼Œæ ¹æ®å…ƒç´ ç±»å‹é€‰æ‹©å¤„ç†æ–¹å¼
                        async function processElement(element, elementIndex) {
                            // ä¸å¯åˆ†å‰²çš„å…ƒç´ ç±»å‹ï¼šè¡¨æ ¼ã€å›¾ç‰‡ã€é“¾æ¥ã€æ°´å¹³çº¿ã€ä»£ç å—ç­‰
                            const indivisibleElements = ['TABLE', 'IMG', 'A', 'HR', 'PRE', 'CODE', 'BLOCKQUOTE'];
                            
                            // æ£€æŸ¥å…ƒç´ æœ¬èº«æ˜¯å¦æ˜¯ä¸å¯åˆ†å‰²ç±»å‹ï¼Œæˆ–è€…åŒ…å«è¿™äº›å…ƒç´ 
                            if (indivisibleElements.includes(element.tagName) || 
                                element.querySelector('img, a, table, hr, pre, code, blockquote')) {
                                // æŒ‰æ•´ä¸ªå…ƒç´ å¤„ç†
                                return await processElementAsWhole(element, elementIndex);
                            } else {
                                // æŒ‰è¡Œåˆ†é¡µå¤„ç†
                                return await processTextElementByLines(element, elementIndex);
                            }
                        }

                        // å¤„ç†åˆ—è¡¨é¡¹åˆ†é¡µçš„å‡½æ•°
                        async function processListElement(listElement, elementIndex) {
                            const listItems = Array.from(listElement.children);
                            if (listItems.length === 0) {
                                await processElement(listElement, elementIndex);
                                return;
                            }

                            console.log(`Processing list with ${listItems.length} items`);
                            
                            // åˆ›å»ºä¸€ä¸ªæ–°çš„åˆ—è¡¨å®¹å™¨
                            let currentList = document.createElement(listElement.tagName);
                            currentList.className = listElement.className;
                            
                            // ä¿æŒæœ‰åºåˆ—è¡¨çš„èµ·å§‹åºå·
                            let currentStartNumber = 1;
                            if (listElement.tagName === 'OL') {
                                const startAttr = listElement.getAttribute('start');
                                currentStartNumber = startAttr ? parseInt(startAttr) : 1;
                                currentList.setAttribute('start', currentStartNumber);
                            }
                            
                            for (let i = 0; i < listItems.length; i++) {
                                const listItem = listItems[i];
                                
                                // æ£€æŸ¥åˆ—è¡¨é¡¹å†…æ˜¯å¦åŒ…å«å®½è¡¨æ ¼ï¼Œå¦‚æœæœ‰åˆ™è½¬æ¢ä¸ºå›¾ç‰‡
                                let clonedItem = listItem.cloneNode(true);
                                const tableInItem = clonedItem.querySelector('table');
                                if (tableInItem) {
                                    const firstRow = tableInItem.querySelector('tr');
                                    const columnCount = firstRow ? firstRow.children.length : 0;
                                    
                                    if (columnCount > 4) {
                                        console.log(`Converting wide table with ${columnCount} columns inside list item to image`);
                                        const imgElement = await convertWideTableToImage(tableInItem);
                                        tableInItem.replaceWith(imgElement);
                                    }
                                }
                                
                                // åˆ›å»ºä¸´æ—¶åˆ—è¡¨æ¥æµ‹è¯•é«˜åº¦
                                const tempList = currentList.cloneNode(true);
                                tempList.appendChild(clonedItem);
                                
                                // å¦‚æœå½“å‰é¡µé¢ä¸ºç©ºï¼Œç›´æ¥æ·»åŠ åˆ—è¡¨
                                if (pageContentDiv.children.length === 0) {
                                    currentList.appendChild(clonedItem);
                                    pageContentDiv.appendChild(currentList);
                                    console.log(`First list item added to page.`);
                                    continue;
                                }
                                
                                // æ£€æŸ¥æœ€åä¸€ä¸ªå…ƒç´ æ˜¯å¦ä¸ºç›¸åŒç±»å‹çš„åˆ—è¡¨
                                const lastChild = pageContentDiv.lastElementChild;
                                const canMergeWithLastList = lastChild && 
                                    lastChild.tagName === listElement.tagName && 
                                    lastChild.className === listElement.className;
                                
                                if (canMergeWithLastList) {
                                    // å°è¯•æ·»åŠ åˆ°ç°æœ‰åˆ—è¡¨
                                    lastChild.appendChild(clonedItem);
                                    pageContentDiv.offsetHeight;
                                    const currentHeight = pageContentDiv.scrollHeight;
                                    
                                    if (currentHeight > contentHeight + 20) {
                                        // ç§»é™¤åˆšæ·»åŠ çš„é¡¹ç›®
                                        lastChild.removeChild(clonedItem);
                                        
                                        // åˆ›å»ºæ–°é¡µé¢
                                        createNewPage();
                                        
                                        // åœ¨æ–°é¡µé¢åˆ›å»ºæ–°åˆ—è¡¨ï¼Œä¿æŒåºå·è¿ç»­æ€§
                                        currentList = document.createElement(listElement.tagName);
                                        currentList.className = listElement.className;
                                        
                                        // ä¸ºæœ‰åºåˆ—è¡¨è®¾ç½®æ­£ç¡®çš„èµ·å§‹åºå·
                                        if (listElement.tagName === 'OL') {
                                            const newStartNumber = currentStartNumber + i;
                                            currentList.setAttribute('start', newStartNumber);
                                            console.log(`Setting OL start number to ${newStartNumber}`);
                                        }
                                        
                                        currentList.appendChild(clonedItem);
                                        pageContentDiv.appendChild(currentList);
                                        console.log(`List item moved to new page.`);
                                    } else {
                                        console.log(`List item merged with existing list.`);
                                    }
                                } else {
                                    // æœ€åä¸€ä¸ªå…ƒç´ ä¸æ˜¯ç›¸åŒç±»å‹çš„åˆ—è¡¨ï¼Œåˆ›å»ºæ–°çš„åˆ—è¡¨
                                    currentList = document.createElement(listElement.tagName);
                                    currentList.className = listElement.className;
                                    
                                    // ä¸ºæœ‰åºåˆ—è¡¨è®¾ç½®æ­£ç¡®çš„èµ·å§‹åºå·
                                    if (listElement.tagName === 'OL') {
                                        const newStartNumber = currentStartNumber + i;
                                        currentList.setAttribute('start', newStartNumber);
                                        console.log(`Setting OL start number to ${newStartNumber}`);
                                    }
                                    
                                    currentList.appendChild(clonedItem);
                                    
                                    // æµ‹è¯•æ˜¯å¦èƒ½æ”¾å…¥å½“å‰é¡µé¢
                                    pageContentDiv.appendChild(currentList);
                                    pageContentDiv.offsetHeight;
                                    const currentHeight = pageContentDiv.scrollHeight;
                                    
                                    if (currentHeight > contentHeight + 20) {
                                        // ç§»é™¤åˆ—è¡¨ï¼Œåˆ›å»ºæ–°é¡µé¢
                                        pageContentDiv.removeChild(currentList);
                                        createNewPage();
                                        pageContentDiv.appendChild(currentList);
                                        console.log(`New list created on new page.`);
                                    } else {
                                        console.log(`New list created on current page.`);
                                    }
                                }
                            }
                        }

                        // éå†æ‰€æœ‰å…ƒç´ è¿›è¡Œåˆ†é¡µï¼ˆæ”¯æŒå¼‚æ­¥å¤„ç†ï¼‰
                        for (let i = 0; i < elements.length; i++) {
                            const element = elements[i];
                            
                            // ç‰¹æ®Šå¤„ç†åˆ—è¡¨å…ƒç´ 
                            if (element.tagName === 'UL' || element.tagName === 'OL') {
                                await processListElement(element, i);
                            } else {
                                await processElement(element, i);
                            }
                        }
                        
                        // è°ƒæ•´æœ€åä¸€é¡µçš„é«˜åº¦ä»¥é€‚åº”å®é™…å†…å®¹
                        if (pageContentDiv && pageContentDiv.children.length > 0) {
                            const actualHeight = pageContentDiv.scrollHeight;
                            const minRequiredHeight = actualHeight + (state.padding * 2);
                            if (minRequiredHeight < pageHeight) {
                                pageContentDiv.style.height = `${actualHeight}px`;
                                pageContentDiv.style.minHeight = 'auto';
                                pageContentDiv.style.maxHeight = 'none';
                                currentPageDiv.style.height = `${minRequiredHeight}px`;
                                console.log(`Adjusted last page height to ${minRequiredHeight}px (content: ${actualHeight}px)`);
                            }
                        }
                        
                        // åœ¨æ‰€æœ‰å†…å®¹æ·»åŠ å®Œæˆåï¼Œå¯¹æ¯ä¸ªé¡µé¢é‡æ–°åº”ç”¨ä¸»é¢˜æ ·å¼
                        console.log('Applying theme to all pages after content is added');
                        const allPages = previewArea.querySelectorAll('.preview-page');
                        allPages.forEach(page => {
                            const content = page.querySelector('.preview-page-content');
                            if (content) {
                                applyTheme(page, content);
                            }
                        });

                    } catch (error) {
                        console.error('Error in renderAndPaginate:', error);
                    }
                }

                

                function applyTheme(pageContainer, contentContainer) {
                    console.log('applyTheme called with theme:', state.theme);
                    const currentTheme = themes[state.theme] || themes.sunshine;
                    console.log('Theme object:', currentTheme);
                    const pageBg = currentTheme.background;
                    const textColor = currentTheme.text;
                    const accentColor = currentTheme.accent;
                    const borderColor = currentTheme.border;
                    const codeBackground = currentTheme.codeBackground;
                    const headingColor = currentTheme.headingColor;
                    const strongColor = currentTheme.strongColor;
                    const linkColor = currentTheme.linkColor;
                    const blockquoteStyle = currentTheme.blockquoteStyle;
                    
                    pageContainer.style.backgroundColor = pageBg;
                    contentContainer.style.color = textColor;
                    
                    // H1-H6 æ ‡é¢˜æ ·å¼ - ä½¿ç”¨ä¸»é¢˜çš„æ ‡é¢˜é¢œè‰²
                    contentContainer.querySelectorAll('h1').forEach(h1 => {
                        h1.style.setProperty('color', headingColor, 'important');
                        // h1çš„å…¶ä»–æ ·å¼ä¿æŒCSSé»˜è®¤ï¼Œä¸éœ€è¦é‡å¤è®¾ç½®
                    });
                    
                    contentContainer.querySelectorAll('h2').forEach(h2 => {
                        h2.style.setProperty('color', headingColor, 'important');
                        // h2çš„å…¶ä»–æ ·å¼ä¿æŒCSSé»˜è®¤ï¼Œä¸éœ€è¦é‡å¤è®¾ç½®
                    });
                    
                    contentContainer.querySelectorAll('h3').forEach(h3 => {
                        h3.style.setProperty('color', headingColor, 'important');
                        // h3çš„å…¶ä»–æ ·å¼ä¿æŒCSSé»˜è®¤ï¼Œä¸éœ€è¦é‡å¤è®¾ç½®
                    });
                    
                    contentContainer.querySelectorAll('h4').forEach(h4 => {
                        h4.style.setProperty('color', headingColor, 'important');
                        // h4çš„å…¶ä»–æ ·å¼ä¿æŒCSSé»˜è®¤ï¼Œä¸éœ€è¦é‡å¤è®¾ç½®
                    });
                    
                    contentContainer.querySelectorAll('h5').forEach(h5 => {
                        h5.style.setProperty('color', headingColor, 'important');
                        // h5çš„å…¶ä»–æ ·å¼ä¿æŒCSSé»˜è®¤ï¼Œä¸éœ€è¦é‡å¤è®¾ç½®
                    });
                    
                    contentContainer.querySelectorAll('h6').forEach(h6 => {
                        h6.style.setProperty('color', headingColor, 'important');
                        // h6çš„å…¶ä»–æ ·å¼ä¿æŒCSSé»˜è®¤ï¼Œä¸éœ€è¦é‡å¤è®¾ç½®
                    });
                    
                    // å¼•ç”¨å—æ ·å¼ - ä½¿ç”¨ä¸»é¢˜çš„å¼•ç”¨å—æ ·å¼
                    contentContainer.querySelectorAll('blockquote').forEach(bq => {
                        bq.style.setProperty('background', blockquoteStyle.background, 'important');
                        bq.style.setProperty('color', blockquoteStyle.color, 'important');
                        bq.style.setProperty('box-shadow', blockquoteStyle.boxShadow, 'important');
                        bq.style.borderLeft = 'none';
                        bq.style.padding = '0.6em';
                        bq.style.borderRadius = '0 0 0.6em 0.6em';
                        bq.style.margin = '0.5em 0';
                        
                        // å¼•ç”¨å—å†…çš„æ®µè½æ ·å¼
                        bq.querySelectorAll('p').forEach(p => {
                            p.style.setProperty('color', blockquoteStyle.color, 'important');
                            p.style.fontSize = '0.8em';
                            p.style.margin = '0';
                            p.style.letterSpacing = 'normal';
                        });
                    });
                    
                    // åŠ ç²—æ–‡å­—æ ·å¼ - ä½¿ç”¨ä¸»é¢˜çš„åŠ ç²—é¢œè‰²
                    contentContainer.querySelectorAll('strong').forEach(strong => {
                        strong.style.setProperty('color', strongColor, 'important');
                        strong.style.fontWeight = 'bold';
                    });
                    
                    // é“¾æ¥æ ·å¼ - ä½¿ç”¨ä¸»é¢˜çš„é“¾æ¥é¢œè‰²
                    contentContainer.querySelectorAll('a').forEach(link => {
                        link.style.setProperty('color', linkColor, 'important');
                        link.style.textDecoration = 'none';
                        link.style.setProperty('border-bottom', `1px solid ${linkColor}`, 'important');
                    });

                    // æ–œä½“æ ·å¼ - ä½¿ç”¨å¼ºè°ƒè‰²
                    contentContainer.querySelectorAll('em').forEach(em => {
                        em.style.setProperty('color', strongColor, 'important');
                        em.style.letterSpacing = '0.3em';
                    });
                    
                    // é€šç”¨æ ·å¼
                    contentContainer.querySelectorAll('th').forEach(th => {
                        th.style.backgroundColor = codeBackground;
                        th.style.color = textColor;
                        th.style.borderColor = borderColor;
                    });
                    
                    contentContainer.querySelectorAll('td').forEach(td => {
                        td.style.borderColor = borderColor;
                    });
                    
                    contentContainer.querySelectorAll('code:not(pre code)').forEach(code => {
                        code.style.backgroundColor = codeBackground;
                        code.style.color = textColor;
                        code.style.padding = '2px 4px';
                        code.style.borderRadius = '3px';
                    });
                    
                    contentContainer.querySelectorAll('hr').forEach(hr => {
                        hr.style.borderColor = borderColor;
                    });
                }

                // --- EVENT LISTENERS ---

                markdownInput.addEventListener('input', (e) => {
                    state.markdown = e.target.value;
                    renderAndPaginate();
                });

                themeSelect.addEventListener('change', (e) => {
                    state.theme = e.target.value;
                    renderAndPaginate();
                });
                
                fontSelect.addEventListener('change', (e) => {
                    state.fontFamily = e.target.value;
                    renderAndPaginate();
                });

                paddingSlider.addEventListener('input', (e) => {
                    state.padding = parseInt(e.target.value);
                    paddingValue.textContent = state.padding;
                    renderAndPaginate();
                });
                
                fontSizeSlider.addEventListener('input', (e) => {
                    state.fontSize = parseInt(e.target.value);
                    fontSizeValue.textContent = state.fontSize;
                    renderAndPaginate();
                });

                watermarkCheckbox.addEventListener('change', (e) => {
                    state.showWatermark = e.target.checked;
                    renderAndPaginate();
                });

                // --- EXPORT LOGIC ---
                exportBtn.addEventListener('click', async () => {
                    loadingIndicator.classList.remove('hidden');
                    loadingIndicator.classList.add('flex');
                    exportBtn.disabled = true;
                    
                    try {
                        const zip = new JSZip();
                        const pages = previewArea.querySelectorAll('.preview-page');

                        for (let i = 0; i < pages.length; i++) {
                            const page = pages[i];
                            try {
                                console.log(`Exporting page ${i + 1} using dom-to-image with high quality`);
                                
                                // è·å–é¡µé¢çš„å®é™…å°ºå¯¸
                                const pageWidth = page.offsetWidth;
                                const pageHeight = page.offsetHeight;
                                
                                // ä½¿ç”¨æ›´é«˜çš„ç¼©æ”¾æ¯”ä¾‹ä»¥æå‡æ¸…æ™°åº¦ï¼ˆ5å€ï¼‰
                                const scale = 5;
                                const scaledWidth = pageWidth * scale;
                                const scaledHeight = pageHeight * scale;
                                
                                console.log(`Page ${i + 1} original: ${pageWidth}x${pageHeight}, scaled: ${scaledWidth}x${scaledHeight}`);
                                
                                // ä½¿ç”¨ dom-to-image è½¬æ¢é¡µé¢ä¸ºé«˜æ¸…å›¾ç‰‡
                                const blob = await domtoimage.toBlob(page, {
                                    width: scaledWidth,
                                    height: scaledHeight,
                                    style: {
                                        transform: `scale(${scale})`,
                                        transformOrigin: 'top left',
                                        width: pageWidth + 'px',
                                        height: pageHeight + 'px'
                                    },
                                    quality: 1.0,
                                    cacheBust: true
                                });
                                
                                console.log(`Page ${i + 1} exported successfully, size: ${(blob.size / 1024).toFixed(2)} KB`);
                                
                                zip.file(`page-${String(i + 1).padStart(2, '0')}.png`, blob);
                            } catch (error) {
                                console.error('Error generating image for page', i, error);
                                // å¦‚æœ dom-to-image å¤±è´¥ï¼Œå°è¯•å›é€€åˆ° html2canvas
                                try {
                                    console.log(`Falling back to html2canvas for page ${i + 1}`);
                                    const canvas = await html2canvas(page, {
                                        scale: 5,
                                        useCORS: true,
                                        allowTaint: true,
                                        logging: false,
                                        backgroundColor: window.getComputedStyle(page).backgroundColor
                                    });
                                    const blob = await new Promise(resolve => canvas.toBlob(resolve, 'image/png', 1.0));
                                    console.log(`Page ${i + 1} fallback export, size: ${(blob.size / 1024).toFixed(2)} KB`);
                                    zip.file(`page-${String(i + 1).padStart(2, '0')}.png`, blob);
                                } catch (fallbackError) {
                                    console.error('Fallback also failed for page', i, fallbackError);
                                }
                            }
                        }
                        
                        const content = await zip.generateAsync({type: "blob"});
                        const link = document.createElement('a');
                        link.href = URL.createObjectURL(content);
                        link.download = "markdown_pages.zip";
                        document.body.appendChild(link);
                        link.click();
                        document.body.removeChild(link);
                    } catch(error) {
                        console.error('Error in export process', error);
                    } finally {
                        loadingIndicator.classList.add('hidden');
                        loadingIndicator.classList.remove('flex');
                        exportBtn.disabled = false;
                    }
                });
                

                
                // è®¾ç½®ä¸»é¢˜é€‰æ‹©å™¨é»˜è®¤å€¼
                themeSelect.value = state.theme;
                
                // è®¾ç½®å­—ä½“é€‰æ‹©å™¨é»˜è®¤å€¼
                fontSelect.value = state.fontFamily;
                
                // è®¾ç½®æ»‘å—é»˜è®¤å€¼ä¸stateåŒæ­¥
                paddingSlider.value = state.padding;
                paddingValue.textContent = state.padding;
                fontSizeSlider.value = state.fontSize;
                fontSizeValue.textContent = state.fontSize;
                
                // è®¾ç½®æ°´å°å¤é€‰æ¡†é»˜è®¤å€¼
                watermarkCheckbox.checked = state.showWatermark;
                
                // Initial render
                renderAndPaginate();
            };

            // Check if libraries are loaded, if not wait and retry
            if (checkLibraries()) {
                initApp();
            } else {
                setTimeout(() => {
                    if (checkLibraries()) {
                        initApp();
                    } else {
                        console.error('Required libraries failed to load');
                    }
                }, 1000);
            }
        });
    </script>
</body>
</html>
